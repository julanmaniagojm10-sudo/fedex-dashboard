<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FedEx Employee Dashboard</title>
<style>
  body { font-family:"Segoe UI",Arial,sans-serif; background:linear-gradient(135deg,#4D148C 40%,#FF6600 100%); margin:0; padding:40px 20px; }
  .dashboard { max-width:900px; margin:auto; background:rgba(255,255,255,0.9); backdrop-filter:blur(12px); border-radius:16px; padding:30px 40px 60px 40px; box-shadow:0 10px 35px rgba(0,0,0,0.2); position:relative; animation:fadeIn 0.8s ease-in-out; }
  @keyframes fadeIn{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:translateY(0);} }
  .logo{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
  .logo img{height:40px;}
  #welcome{font-size:20px;color:#4D148C;margin-bottom:20px;}
  .header-right{position:absolute;top:25px;right:35px;}
  .profile{background-color:#4D148C;color:white;width:42px;height:42px;border-radius:50%;text-align:center;line-height:42px;font-weight:bold;cursor:pointer;transition:transform 0.2s;}
  .profile:hover{transform:scale(1.1);}
  .dropdown{display:none;position:absolute;right:0;top:50px;background:white;border:1px solid #ccc;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,0.15);padding:6px 0;z-index:10;}
  .dropdown button{width:100%;background:none;border:none;padding:10px 16px;text-align:left;cursor:pointer;color:#4D148C;font-weight:600;font-size:14px;}
  .dropdown button:hover{background-color:#f5f5f5;color:#FF6600;}
  .form-group{display:flex;flex-direction:column;margin-bottom:14px;}
  label{font-weight:600;margin-bottom:4px;font-size:14px;color:#4D148C;}
  input,select{padding:10px 12px;border:1px solid #ccc;border-radius:8px;font-size:14px;transition:border 0.25s,box-shadow 0.25s;}
  input:focus,select:focus{border-color:#4D148C;box-shadow:0 0 8px rgba(77,20,140,0.3);outline:none;}
  .actions{display:flex;gap:12px;margin-top:10px;}
  button.action-btn{flex:1;padding:12px;border:none;border-radius:10px;font-weight:bold;font-size:14px;color:white;background:linear-gradient(135deg,#4D148C,#7A2FBF);cursor:pointer;position:relative;overflow:hidden;transition:transform 0.2s,background 0.3s;}
  button.action-btn:hover{background:linear-gradient(135deg,#FF6600,#FF8C42);transform:scale(1.05);}
  button.action-btn:disabled{background-color:#ccc;cursor:not-allowed;}
  .status-info{margin:20px 0 12px;font-weight:bold;font-size:16px;text-align:center;}
  #current-status{color:#FF6600;font-size:22px;font-weight:bold;animation:pulse 1.5s infinite;}
  #status-timer{color:#4D148C;font-size:22px;font-weight:bold;margin-left:10px;animation:glow 1.2s infinite alternate;}
  @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.15);color:#4D148C;}}
  @keyframes glow{0%{text-shadow:0 0 4px #FF6600;}50%{text-shadow:0 0 12px #FF6600,0 0 20px #FF6600;}100%{text-shadow:0 0 4px #FF6600;}}
  table{width:100%;border-collapse:collapse;margin-top:12px;}
  th,td{padding:10px 12px;border:1px solid #ccc;text-align:center;font-size:13px;}
  th{background-color:#4D148C;color:white;}
  tr.active-status{border-left:5px solid #FF6600;font-weight:bold;background:rgba(255,102,0,0.1);animation:rowFade 0.6s;}
  @keyframes rowFade{from{opacity:0;transform:translateY(-4px);}to{opacity:1;transform:translateY(0);}}
  .total-summary{text-align:right;margin-top:12px;font-size:14px;font-weight:bold;color:#4D148C;}
  .export-btn-container{position:absolute;bottom:20px;right:20px;display:flex;flex-direction:column;gap:6px;align-items:flex-end;}
  .reminder{font-size:12px;color:#FF6600;text-align:right;}
  .footer{text-align:center;margin-top:22px;font-size:12px;color:#777;}
  @media(max-width:600px){.dashboard{padding:20px 20px;}.actions{flex-direction:column;}.export-btn-container{align-items:stretch;}}

.logo img {
  height: 100px; /* Increase this value to make it bigger */
  width: auto;   /* Keep aspect ratio */
  display: block;
}

.action-btn.small-btn {
  padding: 4px 8px;  /* smaller than default */
  font-size: 11px;    /* smaller text */
  border-radius: 4px; /* optional: smaller corners */
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAFedbBDXSZomKX8MQkBfVBRfi6tl0LTcc",
  authDomain: "fedex-attendance-system.firebaseapp.com",
  projectId: "fedex-attendance-system",
  storageBucket: "fedex-attendance-system.appspot.com",
  messagingSenderId: "1049424874301",
  appId: "1:1049424874301:web:f94559159b19ee39c19354"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if (!currentUser || currentUser.role !== "employee") {
  alert("Access denied or not logged in");
  window.location.href = "index.html";
}

let activeDocId = null;
let activeStartTime = null;
let attendanceRecords = [];

const statuses = [
  "AWAY","LUNCH","BRK1","BRK2","IA-FXF-999-ACCOUNT-UPDATES","IA-FXF-ACR-REPORTS","IA-FXF-AGENCY-DISPUTE","IA-FXF-AGING",
  "IA-FXF-BACKDATE","IA-FXF-BILLING-DISPUTES","IA-FXF-CORRECTIONS","IA-FXF-CUSTOMER-SPECIFIC","IA-FXF-FBO-DISPUTES",
  "IA-FXF-FPAD-COLLECTIONS","IA-FXF-FPS-TEMP","IA-FXF-MACRO","IA-FXF-MBG","IA-FXF-OVERCHARGE-PREP","IA-FXF-OVERCHARGE-PROCESSING",
  "IA-FXF-PAUD-ACCT","IA-FXF-PAUD-EHOT","IA-FXF-PAUD-FREIGHT-PAY","IA-FXF-PAUD-LEVEL-2","IA-FXF-PAUD-PRICING",
  "IA-FXF-PAUD-REGION-CRAU-CARW","IA-FXF-PAUD-TEMP-ACCOUNTS","IA-FXF-PAUD-TEMP-ACCOUNTS-UNKNOWN","IA-FXF-PAUD-VEND-BLOA",
  "IA-FXF-PPP","IA-FXF-PRICING-SMALL","IA-FXF-QUALITY-AUDITS","IA-FXF-REGION-1","IA-FXF-RETURN-MAIL","IA-FXF-REWEIGH",
  "IA-FXF-SALESFORCE-PREPROCESSING","IA-FXF-SPC-PRJ-PROD","IA-FXF-SRC-DISPUTE","IA-FXF-SRC-LTL-TARIFF-DISPUTE",
  "IA-FXF-WEB-REVIEW","IA-FXF-WRITEOFF-PROCESS","IA-FXF-WRITEOFF-REVIEW","MEETING","SYSTEM-DOWN","TEAM LEAD","TRAINING"
];

// ---------- Manila Time Helper ----------
function getManilaTime() {
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  const manilaOffset = 8 * 60; // UTC+8
  return new Date(utc + (manilaOffset * 60000));
}

function getManilaTimeString() {
  const manila = getManilaTime();
  return manila.toTimeString().split(" ")[0]; // hh:mm:ss
}

// ---------- Realtime listener ----------
async function startRealtimeAttendance() {
  const shiftDate = document.getElementById("shiftDate").value;
  const q = query(
    collection(db, "attendance"),
    where("userId", "==", currentUser.id),
    where("shiftDate", "==", shiftDate)
  );

  onSnapshot(q, snapshot => {
    attendanceRecords = [];
    snapshot.forEach(docSnap => {
      attendanceRecords.push({ id: docSnap.id, ...docSnap.data() });
    });
    attendanceRecords.sort((a,b)=> (a.startTime||"").localeCompare(b.startTime||""));
    renderAttendanceTable();
  });
}

// ---------- Render table ----------
function renderAttendanceTable() {
  const tbody = document.getElementById("attendance-body");
  tbody.innerHTML = "";
  let currentActive = "None";
  activeDocId = null; activeStartTime = null;

  attendanceRecords.forEach(r => {
    const isActive = !r.endTime;
    if (isActive) { activeDocId = r.id; activeStartTime = r.startTime; currentActive = r.status; }
    tbody.innerHTML += `<tr class="${isActive?"active-status":""}">
      <td>${r.status}</td>
      <td>${r.startTime||"-"}</td>
      <td>${r.endTime||"-"}</td>
      <td>${normalizeTotalHours(r.totalHours)}</td>
      <td>${r.comment||""}</td>
    </tr>`;
  });

  document.getElementById("current-status").innerText = currentActive;
  document.getElementById("total-hours").innerText = sumTotalHours(attendanceRecords);
}

// ---------- Timer ----------
// ---------- Timer ---------- 
// Updated to use Manila time for consistent calculations
function updateTimer() {
  if (!activeStartTime) { 
    document.getElementById("status-timer").innerText = "00:00:00"; 
    return; 
  }

  // Parse the activeStartTime into parts
  const [sh, sm, ss] = normalizeTimeParts(activeStartTime);
  
  // Get the current Manila time (in Manila timezone)
  const manila = getManilaTime();  
  const start = new Date(manila); // Set start time to Manila time
  start.setHours(sh, sm, ss, 0); // Adjust to the activeStartTime

  // Get the current Manila time for the "now" timestamp
  const now = getManilaTime();

  // Calculate the time difference in milliseconds
  const diff = now - start;
  
  // Convert milliseconds to hours, minutes, seconds
  const hrs = String(Math.floor(diff / 3600000)).padStart(2,"0");
  const mins = String(Math.floor((diff % 3600000) / 60000)).padStart(2,"0");
  const secs = String(Math.floor((diff % 60000) / 1000)).padStart(2,"0");
  
  // Update the timer
  document.getElementById("status-timer").innerText = `${hrs}:${mins}:${secs}`;
}

// ---------- Helpers ----------
function normalizeTimeParts(timeStr) {
  if(!timeStr) return [0,0,0];
  let parts = timeStr.split(":");
  if(parts.length === 2) parts.push("00");
  const nums = parts.map(n => parseInt(n,10));
  if(nums.some(isNaN)) return [0,0,0];
  return nums;
}

function normalizeTotalHours(totalHours) {
  if(!totalHours) return "00:00:00";
  const parts = totalHours.split(":");
  if(parts.length === 2) return totalHours+":00";
  if(parts.length !== 3) return "00:00:00";
  return totalHours;
}

function calculateTotalHours(start, end) {
  const [sh, sm, ss] = normalizeTimeParts(start);
  const [eh, em, es] = normalizeTimeParts(end);
  let diff = ((eh * 3600 + em * 60 + es) - (sh * 3600 + sm * 60 + ss)) * 1000;
  if(diff < 0) diff = 0;
  const hrs = String(Math.floor(diff / 3600000)).padStart(2,'0');
  const mins = String(Math.floor((diff % 3600000) / 60000)).padStart(2,'0');
  const secs = String(Math.floor((diff % 60000) / 1000)).padStart(2,'0');
  return `${hrs}:${mins}:${secs}`;
}

function sumTotalHours(records) {
  if (!records || records.length === 0) return "00:00:00";
  let totalSeconds = 0;
  const excluded = ["BRK1", "BREAK1", "BRK2", "BREAK2", "LUNCH"];
  records.forEach(r => {
    if(!r.totalHours || !r.status) return;
    if(excluded.includes(r.status.toUpperCase())) return;
    const [h,m,s] = normalizeTimeParts(r.totalHours);
    totalSeconds += h * 3600 + m * 60 + s;
  });
  const hrs = String(Math.floor(totalSeconds / 3600)).padStart(2,"0");
  const mins = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2,"0");
  const secs = String(totalSeconds % 60).padStart(2,"0");
  return `${hrs}:${mins}:${secs}`;
}

// ---------- Page load ----------
window.onload = async () => {
  const initials = currentUser.name.split(" ").map(n => n[0]).join("").toUpperCase();
  document.getElementById("profile-initials").innerText = initials;
  document.getElementById("welcome").innerText = `Welcome, ${currentUser.name}`;

  const select = document.getElementById("statusSelect");
  statuses.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.text = s;
    select.appendChild(opt);
  });

  const dateInput = document.getElementById("shiftDate");
  const manila = getManilaTime();
  dateInput.value = manila.toISOString().split("T")[0];

  dateInput.addEventListener("change", startRealtimeAttendance);
  startRealtimeAttendance();
  setInterval(updateTimer, 1000);
};

// ---------- Buttons ----------
window.toggleDropdown = () => { 
  const dd = document.getElementById("profile-dropdown"); 
  dd.style.display = dd.style.display === "block" ? "none" : "block"; 
}

window.checkIn = async () => {
  const shiftDate = document.getElementById("shiftDate").value;
  const status = document.getElementById("statusSelect").value;
  const comment = document.getElementById("comment").value;
  const nowTime = getManilaTimeString();
  if(activeDocId) {
    const total = calculateTotalHours(activeStartTime, nowTime);
    await updateDoc(doc(db,"attendance",activeDocId), { endTime: nowTime, totalHours: total });
  }
  const newDoc = await addDoc(collection(db, "attendance"), {
    userId: currentUser.id,
    shiftDate,
    status,
    startTime: nowTime,
    endTime: "",
    totalHours: "00:00:00",
    comment
  });
  activeDocId = newDoc.id; activeStartTime = nowTime;
};

window.checkOut = async () => {
  if(!activeDocId) return alert("No active status to check out.");
  const now = getManilaTimeString();
  const total = calculateTotalHours(activeStartTime, now);
  await updateDoc(doc(db, "attendance", activeDocId), { endTime: now, totalHours: total });
  activeDocId = null; activeStartTime = null;
};

window.logout = async () => {
  if(activeDocId) {
    const now = getManilaTimeString();
    const total = calculateTotalHours(activeStartTime, now);
    await updateDoc(doc(db, "attendance", activeDocId), { endTime: now, totalHours: total });
  }
  localStorage.removeItem("currentUser"); 
  window.location.href = "index.html";
};

window.exportEOD = async () => {
  const shiftDate = document.getElementById("shiftDate").value;
  const q = query(collection(db, "attendance"), where("userId", "==", currentUser.id), where("shiftDate", "==", shiftDate));
  const snapshot = await getDocs(q);
  let csv = "DomainId,Shiftdate,Status/Activity,Start Time,End Time,Hours,Comment\n";
  snapshot.forEach(docSnap => {
    const r = docSnap.data();
    csv += `${currentUser.id},${r.shiftDate},${r.status},${r.startTime || ''},${r.endTime || ''},${normalizeTotalHours(r.totalHours)},${(r.comment || '').replace(/,/g,' ')}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const link = document.createElement("a"); 
  link.href = URL.createObjectURL(blob); 
  link.download = `EOD_${shiftDate}.csv`; 
  link.click();
};
</script>
</head>

<body>
<div class="dashboard">
  <div class="header-right">
    <div class="profile" id="profile-initials" onclick="toggleDropdown()"></div>
    <div class="dropdown" id="profile-dropdown">
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="logo"><img src="4373166_fedex_logo_logos_icon.png" alt="FedEx Logo"></div>
  <h2 id="welcome"></h2>

  <div class="form-group">
    <label>Shift Date</label>
    <input type="date" id="shiftDate">
  </div>

  <div class="form-group">
    <label>Status/Activity</label>
    <select id="statusSelect">
      <option value="" disabled selected>Select an Activity...</option>
    </select>
  </div>

  <div class="form-group">
    <label>Comment (Optional)</label>
    <input type="text" id="comment" placeholder="Add a note...">
  </div>

  <div class="actions">
    <button class="action-btn" onclick="checkIn()">Check In</button>
    <button class="action-btn" onclick="checkOut()">Check Out</button>
  </div>

  <div class="status-info">
    Current Status: <span id="current-status">None</span> |
    Timer: <span id="status-timer">00:00:00</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Status/Activity</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Total Hours</th>
        <th>Comments</th>
      </tr>
    </thead>
    <tbody id="attendance-body"></tbody>
  </table>

  <div class="total-summary" style="display:flex; justify-content:space-between; align-items:center; margin:10px 0;">
    <div style="flex: 0 0 auto;">
      <button class="action-btn" onclick="exportEOD()">Export EOD Report</button>
    </div>
    <div style="flex: 0 0 auto;">
      Total Hours for the Day: <span id="total-hours">00:00:00</span>
    </div>
  </div>

  <div class="export-btn-container">
    <div class="reminder">⚠️ System is still subjected for testing. Please reach out for errors encountered. -Jules</div>
  </div>

  <div class="footer">© 2025 FedEx Tracking System</div>
</div>
</body>
</html>
