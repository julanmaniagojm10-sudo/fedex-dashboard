<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<style>
/* KEEP ALL YOUR EXISTING STYLES INTACT */
body { font-family:"Segoe UI",Arial,sans-serif; background:linear-gradient(135deg,#4D148C 40%,#FF6600 100%); margin:0; padding:40px 20px; }
.dashboard { max-width:1100px;margin:auto;background:rgba(255,255,255,0.9);backdrop-filter:blur(12px);border-radius:16px;padding:30px 40px 60px 40px;box-shadow:0 10px 35px rgba(0,0,0,0.2);position:relative;animation:fadeIn 0.8s ease-in-out; }
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:translateY(0);} }
h2{margin-bottom:20px;color:#4D148C;}
.profile{background-color:#4D148C;color:white;width:42px;height:42px;border-radius:50%;text-align:center;line-height:42px;font-weight:bold;cursor:pointer;position:absolute;top:20px;right:20px;}
.profile:hover{transform:scale(1.1);}
.dropdown{display:none;position:absolute;right:20px;top:65px;background:white;border:1px solid #ccc;border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,0.15);padding:6px 0;z-index:10;}
.dropdown button{width:100%;background:none;border:none;padding:10px 16px;text-align:left;cursor:pointer;color:#4D148C;font-weight:600;}
.dropdown button:hover{background-color:#f5f5f5;color:#FF6600;}
.filter-panel{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;align-items:center;}
input,select,button{padding:8px 12px;border-radius:8px;border:1px solid #ccc;font-size:14px;}
button{cursor:pointer;font-weight:bold;color:white;background:linear-gradient(135deg,#4D148C,#7A2FBF);border:none;}
button:hover{background:linear-gradient(135deg,#FF6600,#FF8C42);}
table{width:100%;border-collapse:collapse;margin-top:15px;background:rgba(255,255,255,0.95);border-radius:10px;overflow:hidden;table-layout:fixed;}
th,td{border-bottom:1px solid #ddd;padding:10px;text-align:center;word-wrap:break-word;font-size:13px;}
th{background:#4D148C;color:white;}
.status.active{color:green;font-weight:bold;}
.status.inactive{color:red;font-weight:bold;}
.current-activity{cursor:pointer;color:#4D148C;text-decoration:none;}
.current-activity:hover{color:#FF6600;text-decoration:underline;}
#activityModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;z-index:1200;}
#modalContent{background:rgba(255,255,255,0.95);backdrop-filter:blur(12px);width:80%;max-height:85%;overflow-y:auto;padding:20px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,0.2);position:relative;}
#modalClose{position:absolute;top:10px;right:15px;font-size:20px;font-weight:bold;cursor:pointer;}
.small-btn{padding:4px 8px;font-size:13px;border-radius:6px;}
.edit-btn{background:#2196F3;color:white;}
.save-btn{background:#28a745;color:white;}
.cancel-btn{background:#f44336;color:white;}
.checkout{position:absolute;bottom:20px;right:20px;background:#FF6600;color:white;padding:8px 12px;border-radius:8px;}
@media(max-width:768px){.filter-panel{flex-direction:column;align-items:stretch;}.checkout{position:static;margin-top:15px;}}
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// ---------------- Firebase config ----------------
const firebaseConfig = {
  apiKey: "AIzaSyAFedbBDXSZomKX8MQkBfVBRfi6tl0LTcc",
  authDomain: "fedex-attendance-system.firebaseapp.com",
  projectId: "fedex-attendance-system",
  storageBucket: "fedex-attendance-system.appspot.com",
  messagingSenderId: "1049424874301",
  appId: "1:1049424874301:web:f94559159b19ee39b19354"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------------- Admin guard ----------------
const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if(!currentUser || currentUser.role!=="admin"){ alert("Access denied."); window.location.href="index.html"; }
window.toggleDropdown = () => { const dd=document.getElementById("profile-dropdown"); dd.style.display=dd.style.display==="block"?"none":"block"; }
window.logout = () => { localStorage.removeItem("currentUser"); window.location.href="index.html"; }

// ---------------- Profile initials ----------------
document.addEventListener("DOMContentLoaded",()=>{ 
  document.getElementById("profile-initials").textContent = currentUser.name ? currentUser.name[0].toUpperCase() : "A";
});

// ---------------- Manila Date & Time Helpers ----------------
const getDate = () => {
  const options = { timeZone: 'Asia/Manila', year: 'numeric', month: '2-digit', day: '2-digit' };
  const parts = new Intl.DateTimeFormat('en-GB', options).formatToParts(new Date());
  const y = parts.find(p => p.type==='year').value;
  const m = parts.find(p => p.type==='month').value;
  const d = parts.find(p => p.type==='day').value;
  return `${y}-${m}-${d}`; // YYYY-MM-DD
};
const getManilaTime = () => {
  const now = new Date();
  const options = { timeZone:'Asia/Manila', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false };
  return new Intl.DateTimeFormat('en-GB', options).format(now);
};

// ---------------- Globals ----------------
let employees = [], attendance = [];
let currentFilter = "all";
let currentTeamLeader = "all";

// ---------------- Load Employees ----------------
async function loadEmployees(){
  const empSnap = await getDocs(collection(db,"employees"));
  employees = empSnap.docs.map(d=>({id:d.id,...d.data()}));
}

// ---------------- Team Leader Dropdown ----------------
async function loadTeamLeaderDropdown(){
  const dropdown = document.getElementById("teamLeaderFilter");
  const leaders = [...new Set(employees.map(e=>e.teamLeader).filter(Boolean))];
  dropdown.innerHTML='<option value="all">All Team Leaders</option>';
  leaders.forEach(l => dropdown.innerHTML += `<option value="${l}">${l}</option>`);
}

// ---------------- Render Dashboard ----------------
function renderDashboard() {
  const tbody = document.getElementById("main-body");
  tbody.innerHTML = "";
  const searchId = document.getElementById("searchID").value.trim().toLowerCase();
  const dateFilter = document.getElementById("searchDate").value || getDate();

  for(const emp of employees){
    if(currentTeamLeader !== "all" && emp.teamLeader !== currentTeamLeader) continue;
    if(searchId && !emp.domainId?.toLowerCase().includes(searchId)) continue;

    const uid = emp.id;
    const logs = attendance.filter(a => a.userId === uid && a.shiftDate === dateFilter);
    const latest = logs[logs.length-1];
    const activeAttendance = logs.find(a => !a.endTime);
    const isActive = !!activeAttendance;
    let currentActivityText = "", activityStart = "";
    if(activeAttendance){ currentActivityText=activeAttendance.status; activityStart=activeAttendance.startTime||""; }
    else if(latest){ currentActivityText="Checked Out"; }
    else { currentActivityText="No Activity"; }

    if(currentFilter==="active" && !activeAttendance) continue;
    if(currentFilter==="inactive" && activeAttendance) continue;

    tbody.innerHTML += `
      <tr data-user="${uid}" data-attendance="${activeAttendance?.id||''}">
        <td><input type="checkbox" class="row-checkbox"></td>
        <td>${emp.domainId || ""}</td>
        <td>${dateFilter}</td>
        <td><span class="current-activity" data-starttime="${activityStart}" data-status="${currentActivityText}" onclick="viewActivity('${uid}','${dateFilter}')">${currentActivityText}</span></td>
        <td><span class="status ${isActive?"active":"inactive"}">${isActive?"Active":"Inactive"}</span></td>
      </tr>`;
  }

  if(!tbody.innerHTML) tbody.innerHTML="<tr><td colspan='5'>No records found</td></tr>";
  setupCheckboxListeners();
  tickActivityDurations();
}

// ---------------- Filters ----------------
window.setFilter = (f) => { currentFilter=f; renderDashboard(); }
window.setTeamLeaderFilter = (tl) => { currentTeamLeader=tl; renderDashboard(); }

// ---------------- Checkbox Helpers ----------------
function setupCheckboxListeners(){
  const allCheckbox = document.getElementById("selectAllCheckbox");
  const rowCheckboxes = document.querySelectorAll(".row-checkbox");
  allCheckbox.checked=false;
  allCheckbox.onclick=()=>{ rowCheckboxes.forEach(cb=>cb.checked=allCheckbox.checked); toggleActionButtons(); }
  rowCheckboxes.forEach(cb=>{ cb.onchange=toggleActionButtons; });
}
function toggleActionButtons(){
  const checkedBoxes=document.querySelectorAll(".row-checkbox:checked");
  document.getElementById("deleteBtn").style.display=checkedBoxes.length?"inline-block":"none";
  document.getElementById("exportBtn").style.display=checkedBoxes.length?"inline-block":"none";
}

// ---------------- Tick Activity Durations ----------------
function tickActivityDurations(){
  document.querySelectorAll(".current-activity").forEach(span=>{
    const startTime = span.dataset.starttime;
    const status = span.dataset.status || "";
    if(!startTime || status==="Checked Out" || status==="No Activity"){ span.textContent=status; return; }

    const [sh, sm, ss] = startTime.split(":").map(Number);
    if([sh,sm,ss].some(isNaN)){ span.textContent = status + " (00:00:00)"; return; }

    const [nh, nm, ns] = getManilaTime().split(":").map(Number);
    let diffSec = (nh*3600 + nm*60 + ns) - (sh*3600 + sm*60 + ss);
    if(diffSec < 0) diffSec = 0;

    const hrs = String(Math.floor(diffSec/3600)).padStart(2,'0');
    const mins = String(Math.floor((diffSec%3600)/60)).padStart(2,'0');
    const secs = String(diffSec%60).padStart(2,'0');

    span.textContent = `${status} (${hrs}:${mins}:${secs})`;
  });
}
setInterval(tickActivityDurations,1000);
// ---------------- Search Inputs ----------------
document.getElementById("searchID").addEventListener("input", renderDashboard);
document.getElementById("searchDate").addEventListener("change", renderDashboard);

// ---------------- Modal & Activity ----------------
window.viewActivity = async(userId,date)=>{
  document.getElementById("activityModal").style.display="flex";
  document.getElementById("modal-username").textContent=`${userId} (${date})`;
  const tbody = document.getElementById("activity-body"); tbody.innerHTML="";
  const snap = await getDocs(query(collection(db,"attendance"), where("userId","==",userId), where("shiftDate","==",date)));
  const docs=[]; snap.forEach(s=>docs.push({id:s.id, ...s.data()}));
  docs.sort((a,b)=>(a.startTime||"00:00:00").localeCompare(b.startTime||"00:00:00"));
  if(docs.length===0){ tbody.innerHTML="<tr><td colspan='5'>No activity records</td></tr>"; return; }

  for(const d of docs){
    const isActive = !d.endTime;
    tbody.innerHTML += `
      <tr data-id="${d.id}">
        <td class="act-status">${d.status||""}</td>
        <td class="act-start">${d.startTime||"-"}</td>
        <td class="act-end">${isActive?`<span class="activity-timer">00:00:00</span>`:d.endTime||"-"}</td>
        <td class="act-comment">${d.comment||""}</td>
        <td><button class="small-btn edit-btn" onclick="beginEditRow('${d.id}')">Edit</button></td>
      </tr>`;
  }
  startActivityModalTimer();
};

function startActivityModalTimer(){
  clearInterval(window.activityTimerInterval);
  window.activityTimerInterval=setInterval(()=>{
    document.querySelectorAll("#activity-body tr").forEach(row=>{
      const timerCell=row.children[2].querySelector(".activity-timer");
      if(!timerCell) return;
      const startText=row.children[1].textContent; if(!startText||startText=="-") return;
      const [sh,sm,ss]=startText.split(":").map(Number); if([sh,sm,ss].some(isNaN)) return;

      const [nh,nm,ns] = getManilaTime().split(":").map(Number);
      let diffSec = (nh*3600 + nm*60 + ns) - (sh*3600 + sm*60 + ss);
      if(diffSec < 0) diffSec = 0;

      const hrs = String(Math.floor(diffSec/3600)).padStart(2,'0');
      const mins = String(Math.floor((diffSec%3600)/60)).padStart(2,'0');
      const secs = String(diffSec%60).padStart(2,'0');

      timerCell.textContent=`${hrs}:${mins}:${secs}`;
    });
  },1000);
}

window.closeModal=()=>{ 
  document.getElementById("activityModal").style.display="none"; 
  clearInterval(window.activityTimerInterval); 
}

// ---------------- Checkout ----------------
function calculateTotalHours(start,end){
  if(!start||!end) return "00:00:00";
  const [sh,sm,ss]=start.split(":").map(Number);
  const [eh,em,es]=end.split(":").map(Number);
  let diffSec = (eh*3600+em*60+es) - (sh*3600+sm*60+ss);
  if(diffSec < 0) diffSec = 0;
  const hrs=String(Math.floor(diffSec/3600)).padStart(2,'0');
  const mins=String(Math.floor((diffSec%3600)/60)).padStart(2,'0');
  const secs=String(diffSec%60).padStart(2,'0');
  return `${hrs}:${mins}:${secs}`;
}

document.querySelector(".checkout").onclick=async ()=>{
  const rows=Array.from(document.querySelectorAll("#activity-body tr"));
  for(const row of rows){
    const timerCell=row.children[2].querySelector(".activity-timer");
    if(timerCell){
      const attId=row.dataset.id; if(!attId) continue;
      const nowTime=getManilaTime();
      const startTime=row.children[1].textContent;
      const totalHours=calculateTotalHours(startTime,nowTime);
      await updateDoc(doc(db,"attendance",attId),{endTime:nowTime,totalHours});
      row.children[2].textContent=nowTime;
    }
  }
  alert("✅ Successfully checked out!");
  renderDashboard();
};

// ---------------- Delete & Export ----------------
document.getElementById("deleteBtn").onclick = async () => {
  const checkedRows = document.querySelectorAll(".row-checkbox:checked");
  if (!checkedRows.length) return;
  if (!confirm(`Are you sure you want to delete punches for ${checkedRows.length} selected record(s)?`)) return;

  try {
    for (const cb of checkedRows) {
      const tr = cb.closest("tr");
      const userId = tr.dataset.user;
      const shiftDate = tr.children[2].textContent;
      if (!userId || !shiftDate) continue;

      const q = query(collection(db, "attendance"), where("userId","==",userId), where("shiftDate","==",shiftDate));
      const snap = await getDocs(q);
      for (const docSnap of snap.docs) { await deleteDoc(doc(db,"attendance",docSnap.id)); }
    }

    alert("✅ Selected attendance records have been successfully deleted.");
    renderDashboard();
  } catch (err) {
    console.error("Error deleting records:", err);
    alert("❌ Failed to delete records. See console for details.");
  }
};

document.getElementById("exportBtn").onclick=()=>{
  const checkedRows=document.querySelectorAll(".row-checkbox:checked"); if(!checkedRows.length) return;
  let csv="Domain ID,Shift Date,Current Activity,Status\n";
  checkedRows.forEach(cb=>{
    const tr=cb.closest("tr"); const tds=tr.querySelectorAll("td");
    const rowValues=Array.from(tds).slice(1).map(td=>`"${(td.textContent||"").replace(/"/g,'""')}"`);
    csv+=rowValues.join(",")+"\n";
  });
  const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=`attendance_export_${getDate()}.csv`; a.click(); URL.revokeObjectURL(url);
};

// ---------------- Real-time Attendance ----------------
function startRealtimeAttendance(){
  const attCol = collection(db,"attendance");
  onSnapshot(attCol,snap=>{
    attendance = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderDashboard();
  });
}

// ---------------- Initial Load ----------------
window.onload = async ()=>{
  document.getElementById("searchDate").value = getDate();
  await loadEmployees();
  await loadTeamLeaderDropdown();
  startRealtimeAttendance();
};

// ---------------- Edit Row in Modal ----------------
window.beginEditRow = (attId) => {
  const row = document.querySelector(`#activity-body tr[data-id="${attId}"]`);
  if (!row) return;

  const statusCell = row.querySelector(".act-status");
  const startCell = row.querySelector(".act-start");
  const endCell = row.querySelector(".act-end");
  const commentCell = row.querySelector(".act-comment");
  const actionCell = row.querySelector("td:last-child");

  // Preserve old values in case of cancel
  const oldStatus = statusCell.textContent;
  const oldStart = startCell.textContent;
  const oldEnd = endCell.textContent;
  const oldComment = commentCell.textContent;

  // Replace cells with inputs
  statusCell.innerHTML = `<input type="text" value="${oldStatus}" style="width:100%">`;
  startCell.innerHTML = `<input type="time" value="${oldStart}" style="width:100%">`;
  endCell.innerHTML = `<input type="time" value="${oldEnd!=="-"?oldEnd:""}" style="width:100%">`;
  commentCell.innerHTML = `<input type="text" value="${oldComment}" style="width:100%">`;

  // Replace Edit button with Save/Cancel
  actionCell.innerHTML = `
    <button class="small-btn save-btn">Save</button>
    <button class="small-btn cancel-btn">Cancel</button>
  `;

  // Save handler
  actionCell.querySelector(".save-btn").onclick = async () => {
    const newStatus = statusCell.querySelector("input").value.trim();
    const newStart = startCell.querySelector("input").value.trim();
    const newEnd = endCell.querySelector("input").value.trim();
    const newComment = commentCell.querySelector("input").value.trim();

    // Update in Firestore
    try {
      await updateDoc(doc(db,"attendance",attId),{
        status: newStatus,
        startTime: newStart,
        endTime: newEnd,
        comment: newComment
      });
      // Update row display
      statusCell.textContent = newStatus;
      startCell.textContent = newStart;
      endCell.textContent = newEnd || "-";
      commentCell.textContent = newComment;
      actionCell.innerHTML = `<button class="small-btn edit-btn" onclick="beginEditRow('${attId}')">Edit</button>`;
    } catch (err) {
      console.error("Failed to save row:", err);
      alert("❌ Failed to save. See console for details.");
    }
  };

  // Cancel handler
  actionCell.querySelector(".cancel-btn").onclick = () => {
    statusCell.textContent = oldStatus;
    startCell.textContent = oldStart;
    endCell.textContent = oldEnd;
    commentCell.textContent = oldComment;
    actionCell.innerHTML = `<button class="small-btn edit-btn" onclick="beginEditRow('${attId}')">Edit</button>`;
  };
};

</script>
</head>
<body>
<div class="dashboard">
<div class="profile" id="profile-initials" onclick="toggleDropdown()">A</div>
<div class="dropdown" id="profile-dropdown"><button onclick="logout()">Logout</button></div>
<h2>Admin Dashboard</h2>
<div class="filter-panel">
<select onchange="setFilter(this.value)"><option value="all">Show All</option><option value="active">Active</option><option value="inactive">Inactive</option></select>
<select id="teamLeaderFilter" onchange="setTeamLeaderFilter(this.value)"><option value="all">All Team Leaders</option></select>
<input type="text" id="searchID" placeholder="Search Domain ID">
<input type="date" id="searchDate">
<button id="deleteBtn" style="display:none;">Delete Selected</button>
<button id="exportBtn" style="display:none;">Export</button>
</div>
<table>
<thead><tr><th><input type="checkbox" id="selectAllCheckbox"></th><th>Domain ID</th><th>Shift Date</th><th>Current Activity</th><th>Status</th></tr></thead>
<tbody id="main-body"></tbody>
</table>
<div id="activityModal">
<div id="modalContent">
<span id="modalClose" onclick="closeModal()">×</span>
<h3>Activity Log for: <span id="modal-username"></span></h3>
<table style="width:100%;">
<thead><tr><th>Status</th><th>Start</th><th>End</th><th>Comment</th><th>Action</th></tr></thead>
<tbody id="activity-body"></tbody>
</table>
<button class="checkout">Check Out</button>
</div>
</div>
</div>
</body>
</html>
